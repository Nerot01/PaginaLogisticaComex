<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin | Escuela de Logística</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-dark bg-danger">
        <div class="container">
            <a class="navbar-brand" href="#">Panel de Administración (v2.0)</a>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Cerrar Sesión</button>
        </div>
    </nav>

    <div class="container py-5">
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="actividades-tab" data-bs-toggle="tab" data-bs-target="#actividades"
                    type="button">Actividades</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="biblioteca-tab" data-bs-toggle="tab" data-bs-target="#biblioteca"
                    type="button">Biblioteca</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="lecturas-tab" data-bs-toggle="tab" data-bs-target="#lecturas"
                    type="button">Lecturas</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- ACTIVIDADES -->
            <div class="tab-pane fade show active" id="actividades">
                <div class="card p-4 mb-4">
                    <h5>Nueva Actividad</h5>
                    <form id="actividadForm" enctype="multipart/form-data">
                        <input type="hidden" id="actId" name="id"> <!-- Hidden ID for editing -->
                        <div class="row">
                            <div class="col-md-6 mb-2"><input type="text" class="form-control" id="actTitle"
                                    name="title" placeholder="Título" required></div>
                            <div class="col-md-6 mb-2"><input type="date" class="form-control" id="actDate"
                                    name="date_event" required>
                            </div>
                            <div class="col-md-6 mb-2"><input type="text" class="form-control" id="actPlace"
                                    name="location" placeholder="Lugar" required></div>
                            <div class="col-md-6 mb-2">
                                <select class="form-select" id="actMediaType" name="media_type"
                                    onchange="toggleMediaInput()">
                                    <option value="none">Sin Media</option>
                                    <option value="image">Subir Imagen</option>
                                    <option value="youtube">YouTube (URL)</option>
                                </select>
                            </div>
                            <!-- Input para URL (YouTube) -->
                            <div class="col-12 mb-2" id="divMediaUrl" style="display:none;">
                                <input type="text" class="form-control" id="actMediaUrl" name="media_url"
                                    placeholder="URL del Video (YouTube)">
                            </div>
                            <!-- Input para Archivo (Imagen) -->
                            <div class="col-12 mb-2" id="divMediaFile" style="display:none;">
                                <input type="file" class="form-control" id="actMediaFile" name="media_file"
                                    accept="image/*">
                                <small class="text-muted" id="currentFileMsg"></small>
                            </div>

                            <div class="col-12 mb-2"><textarea class="form-control" id="actDesc" name="description"
                                    placeholder="Descripción" rows="3" required></textarea></div>
                        </div>
                        <button type="submit" class="btn btn-success" id="btnSaveAct">Guardar Actividad</button>
                        <button type="button" class="btn btn-secondary" id="btnCancelAct" style="display:none;"
                            onclick="cancelEditAct()">Cancelar Edición</button>
                    </form>
                </div>
                <hr>
                <h5>Actividades Existentes</h5>
                <div id="actividadesList" class="list-group"></div>
            </div>

            <!-- BIBLIOTECA -->
            <div class="tab-pane fade" id="biblioteca">
                <div class="card p-4 mb-4">
                    <h5>Nuevo Libro en Biblioteca</h5>
                    <form id="bibliotecaForm">
                        <div class="row">
                            <div class="col-md-6 mb-2"><input type="text" class="form-control" id="bibTitle"
                                    placeholder="Título" required></div>
                            <div class="col-12 mb-2"><input type="text" class="form-control" id="bibUrl"
                                    placeholder="URL del PDF (Drive/Directo)" required></div>
                            <div class="col-12 mb-2"><textarea class="form-control" id="bibDesc"
                                    placeholder="Descripción" rows="2"></textarea></div>
                        </div>
                        <button type="submit" class="btn btn-success">Guardar en Biblioteca</button>
                    </form>
                </div>
                <hr>
                <h5>Biblioteca Existente</h5>
                <div id="bibliotecaList" class="list-group"></div>
            </div>

            <!-- LECTURAS -->
            <div class="tab-pane fade" id="lecturas">
                <div class="card p-4 mb-4">
                    <h5>Nueva Lectura Recomendada</h5>
                    <form id="lecturaForm">
                        <div class="row">
                            <div class="col-md-6 mb-2"><input type="text" class="form-control" id="lecTitle"
                                    placeholder="Título" required></div>
                            <div class="col-12 mb-2"><input type="text" class="form-control" id="lecUrl"
                                    placeholder="URL del PDF (Drive/Directo)" required></div>
                            <div class="col-12 mb-2"><textarea class="form-control" id="lecDesc"
                                    placeholder="Descripción" rows="2"></textarea></div>
                        </div>
                        <button type="submit" class="btn btn-success">Guardar Lectura</button>
                    </form>
                </div>
                <hr>
                <h5>Lecturas Existentes</h5>
                <div id="lecturasList" class="list-group"></div>
            </div>
        </div>
    </div>

    <script>
        // Verificar sesión
        fetch('../backend/auth.php?action=check')
            .then(r => r.json())
            .then(d => { if (!d.logged_in) window.location.href = 'login.html'; });

        async function logout() {
            await fetch('../backend/auth.php?action=logout');
            window.location.href = 'login.html';
        }

        // --- ACTIVIDADES ---
        let activitiesData = [];

        function toggleMediaInput() {
            const type = document.getElementById('actMediaType').value;
            document.getElementById('divMediaUrl').style.display = (type === 'youtube') ? 'block' : 'none';
            document.getElementById('divMediaFile').style.display = (type === 'image') ? 'block' : 'none';
        }

        async function loadActivities() {
            const res = await fetch('../backend/api.php?type=activities');
            activitiesData = await res.json();
            const list = document.getElementById('actividadesList');
            list.innerHTML = activitiesData.map(a => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${a.title}</strong> <small class="text-muted">${a.date_event}</small><br>
                        ${a.description.substring(0, 50)}...
                    </div>
                    <div>
                        <button class="btn btn-sm btn-warning me-2" onclick="editActivity(${a.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('activities', ${a.id})">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function editActivity(id) {
            const act = activitiesData.find(a => a.id == id);
            if (!act) return;

            document.getElementById('actId').value = act.id;
            document.getElementById('actTitle').value = act.title;
            document.getElementById('actDate').value = act.date_event;
            document.getElementById('actPlace').value = act.location;
            document.getElementById('actMediaType').value = act.media_type;
            document.getElementById('actDesc').value = act.description;

            // Configurar inputs según tipo
            toggleMediaInput();
            if (act.media_type === 'youtube') {
                document.getElementById('actMediaUrl').value = act.media_url;
            } else if (act.media_type === 'image') {
                document.getElementById('currentFileMsg').textContent = `Imagen actual: ${act.media_url}`;
                // Guardamos la URL actual en el campo oculto o lo manejamos en el backend si no se envía archivo nuevo
                // Para simplificar, usaremos el input de URL para guardar la ruta actual también, aunque esté oculto
                document.getElementById('actMediaUrl').value = act.media_url;
            }

            document.getElementById('btnSaveAct').textContent = 'Actualizar Actividad';
            document.getElementById('btnSaveAct').classList.remove('btn-success');
            document.getElementById('btnSaveAct').classList.add('btn-warning');
            document.getElementById('btnCancelAct').style.display = 'inline-block';
            window.scrollTo(0, 0);
        }

        function cancelEditAct() {
            document.getElementById('actividadForm').reset();
            document.getElementById('actId').value = '';
            document.getElementById('btnSaveAct').textContent = 'Guardar Actividad';
            document.getElementById('btnSaveAct').classList.add('btn-success');
            document.getElementById('btnSaveAct').classList.remove('btn-warning');
            document.getElementById('btnCancelAct').style.display = 'none';
            document.getElementById('currentFileMsg').textContent = '';
            toggleMediaInput();
        }

        document.getElementById('actividadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = document.getElementById('actividadForm');
            const formData = new FormData(form);

            // Si es imagen y no se seleccionó archivo nuevo, asegurarnos de enviar la URL vieja si existe
            // El backend prioriza el archivo, si no hay archivo usa media_url

            await fetch('../backend/api.php?type=activities', {
                method: 'POST', // Usamos POST siempre para FormData
                body: formData
            });

            cancelEditAct();
            loadActivities();
        });

        // --- RECURSOS (BIBLIOTECA & LECTURAS) ---
        async function loadResources(category, listId) {
            const res = await fetch(`../backend/api.php?type=resources&category=${category}`);
            const data = await res.json();
            const list = document.getElementById(listId);
            list.innerHTML = data.map(r => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${r.title}</strong><br>
                        <small><a href="${r.file_url}" target="_blank">Ver Archivo</a></small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteItem('resources', ${r.id})">Eliminar</button>
                </div>
            `).join('');
        }

        document.getElementById('bibliotecaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('bibTitle').value,
                description: document.getElementById('bibDesc').value,
                category: 'biblioteca',
                file_url: document.getElementById('bibUrl').value
            };
            await fetch('../backend/api.php?type=resources', { method: 'POST', body: JSON.stringify(data) });
            e.target.reset();
            loadResources('biblioteca', 'bibliotecaList');
        });

        document.getElementById('lecturaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('lecTitle').value,
                description: document.getElementById('lecDesc').value,
                category: 'lectura',
                file_url: document.getElementById('lecUrl').value
            };
            await fetch('../backend/api.php?type=resources', { method: 'POST', body: JSON.stringify(data) });
            e.target.reset();
            loadResources('lectura', 'lecturasList');
        });

        // --- GENERAL ---
        async function deleteItem(type, id) {
            if (confirm('¿Seguro que deseas eliminar esto?')) {
                await fetch(`../backend/api.php?type=${type}&id=${id}`, { method: 'DELETE' });
                if (type === 'activities') loadActivities();
                else {
                    loadResources('biblioteca', 'bibliotecaList');
                    loadResources('lectura', 'lecturasList');
                }
            }
        }

        // Init
        loadActivities();
        loadResources('biblioteca', 'bibliotecaList');
        loadResources('lectura', 'lecturasList');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>